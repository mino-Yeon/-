<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BFS vs DFS ë¹„êµ ì‹œë®¬ë ˆì´ì…˜</title>
<style>
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:'Segoe UI','ë§‘ì€ ê³ ë”•',sans-serif; background:#f0f2f5; color:#333; }

/* â”€â”€ Header â”€â”€ */
.header { background:linear-gradient(135deg,#2563eb,#7c3aed); color:#fff; padding:16px 24px; text-align:center; }
.header h1 { font-size:1.5rem; margin-bottom:4px; }
.header p { font-size:0.85rem; opacity:0.85; }
.back-link { position:absolute; left:16px; top:16px; color:#fff; text-decoration:none; font-size:0.9rem; }

/* â”€â”€ Tabs â”€â”€ */
.tabs { display:flex; justify-content:center; gap:4px; background:#e2e8f0; padding:6px; }
.tab-btn { padding:10px 28px; border:none; background:transparent; font-size:0.95rem; cursor:pointer;
  border-radius:6px; font-weight:600; color:#64748b; transition:all .2s; }
.tab-btn.active { background:#fff; color:#2563eb; box-shadow:0 1px 3px rgba(0,0,0,.1); }
.tab-content { display:none; }
.tab-content.active { display:block; }

/* â”€â”€ Controls â”€â”€ */
.controls { display:flex; align-items:center; justify-content:center; gap:12px; padding:12px; background:#fff;
  border-bottom:1px solid #e2e8f0; flex-wrap:wrap; }
.controls button { padding:8px 18px; border:none; border-radius:6px; font-size:0.85rem; cursor:pointer;
  font-weight:600; transition:all .15s; }
.btn-start { background:#2563eb; color:#fff; }
.btn-start:hover { background:#1d4ed8; }
.btn-start:disabled { background:#94a3b8; cursor:not-allowed; }
.btn-reset { background:#f1f5f9; color:#475569; border:1px solid #cbd5e1; }
.btn-reset:hover { background:#e2e8f0; }
.speed-wrap { display:flex; align-items:center; gap:6px; font-size:0.8rem; color:#64748b; }
.speed-wrap input[type=range] { width:100px; }

/* â”€â”€ Grid Panel â”€â”€ */
.panels { display:flex; gap:16px; padding:16px; justify-content:center; flex-wrap:wrap; }
.panel { background:#fff; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,.08); padding:16px; min-width:300px; flex:1; max-width:480px; }
.panel h3 { text-align:center; font-size:1.1rem; margin-bottom:8px; padding-bottom:6px; border-bottom:2px solid #e2e8f0; }
.panel h3.bfs-title { color:#2563eb; border-color:#2563eb; }
.panel h3.dfs-title { color:#dc2626; border-color:#dc2626; }

.grid-container { position:relative; margin:0 auto; }
.grid { display:grid; grid-template-columns:repeat(4,64px); grid-template-rows:repeat(4,64px); gap:3px;
  margin:0 auto; width:fit-content; }
.cell { width:64px; height:64px; border:2px solid #cbd5e1; border-radius:8px; display:flex; flex-direction:column;
  align-items:center; justify-content:center; font-size:0.75rem; cursor:pointer; position:relative;
  transition:all .25s; background:#fff; user-select:none; }
.cell .coord { font-size:0.6rem; color:#94a3b8; position:absolute; top:2px; left:4px; }
.cell .depth-num { font-size:1.1rem; font-weight:700; color:#2563eb; }
.cell .visit-order { font-size:0.6rem; color:#64748b; position:absolute; bottom:2px; right:4px; }

/* Cell states */
.cell.start { background:#dbeafe; border-color:#2563eb; }
.cell.end { background:#fef3c7; border-color:#f59e0b; }
.cell.wall { background:#1e293b; border-color:#0f172a; cursor:pointer; }
.cell.wall .coord { color:#64748b; }
.cell.visiting { background:#bfdbfe; border-color:#3b82f6; animation:pulse .5s; }
.cell.visited { background:#e0e7ff; border-color:#6366f1; }
.cell.path-final { background:#bbf7d0; border-color:#16a34a; }
.cell.current { box-shadow:0 0 0 3px #f59e0b; z-index:2; }
.cell.blocked { background:#fee2e2; border-color:#ef4444; }
.cell.blocked::after { content:''; position:absolute; font-size:1rem; }
.cell.unvisited-bt { background:#fff; border-color:#cbd5e1; }
.cell.path-temp { background:#fef9c3; border-color:#eab308; }
@keyframes pulse { 0%{transform:scale(1)} 50%{transform:scale(1.08)} 100%{transform:scale(1)} }

/* SVG overlay for arrows */
.svg-overlay { position:absolute; top:0; left:0; pointer-events:none; }
.arrow-line { stroke-width:2.5; fill:none; }
.arrow-bfs { stroke:#2563eb; }
.arrow-dfs { stroke:#dc2626; }
.arrow-back { opacity:0.25; stroke-dasharray:4,3; }
.arrow-final { stroke-width:3.5; opacity:1; }
.arrow-final.arrow-bfs { stroke:#16a34a; marker-end:url(#arrowHeadGreen); }
.arrow-final.arrow-dfs { stroke:#16a34a; marker-end:url(#arrowHeadGreen); }
.arrow-temp { stroke:#eab308; stroke-width:3; marker-end:url(#arrowHeadYellow); }

/* â”€â”€ Info area â”€â”€ */
.info-area { margin-top:10px; padding:10px; background:#f8fafc; border-radius:8px; font-size:0.8rem; min-height:60px; }
.info-area .label { font-weight:700; color:#475569; margin-bottom:4px; }
.info-area .queue-state { font-family:'Consolas','Courier New',monospace; word-break:break-all; color:#2563eb; }
.info-area .stack-state { font-family:'Consolas','Courier New',monospace; word-break:break-all; color:#dc2626; }
.info-area .depth-info { font-weight:600; margin-top:4px; }
.info-area .msg { margin-top:6px; padding:6px 10px; border-radius:6px; font-weight:600; text-align:center; }
.msg-success { background:#dcfce7; color:#16a34a; }
.msg-fail { background:#fee2e2; color:#dc2626; }
.msg-warn { background:#fef3c7; color:#92400e; }

/* â”€â”€ Legend â”€â”€ */
.legend { display:flex; gap:12px; justify-content:center; padding:10px; flex-wrap:wrap; font-size:0.75rem; }
.legend-item { display:flex; align-items:center; gap:4px; }
.legend-box { width:18px; height:18px; border-radius:4px; border:2px solid #cbd5e1; }

/* â”€â”€ Tab2 specifics â”€â”€ */
.t2-btn-group { display:flex; gap:8px; justify-content:center; padding:16px 16px 0; flex-wrap:wrap; }
.t2-btn-card { background:#fff; border:2px solid #e2e8f0; border-radius:10px; padding:12px 18px; cursor:pointer;
  text-align:center; transition:all .2s; min-width:180px; flex:1; max-width:260px; }
.t2-btn-card:hover { border-color:#3b82f6; transform:translateY(-2px); box-shadow:0 4px 12px rgba(0,0,0,.1); }
.t2-btn-card.active { border-color:#2563eb; background:#eff6ff; }
.t2-btn-card.disabled { opacity:.5; pointer-events:none; }
.t2-btn-card .bc-num { font-size:1.5rem; font-weight:800; margin-bottom:4px; }
.t2-btn-card .bc-title { font-size:0.85rem; font-weight:700; margin-bottom:2px; }
.t2-btn-card .bc-desc { font-size:0.7rem; color:#64748b; }
.t2-btn-card.bc-fail { border-color:#fca5a5; }
.t2-btn-card.bc-fail .bc-num { color:#dc2626; }
.t2-btn-card.bc-warn { border-color:#fcd34d; }
.t2-btn-card.bc-warn .bc-num { color:#f59e0b; }
.t2-btn-card.bc-ok { border-color:#86efac; }
.t2-btn-card.bc-ok .bc-num { color:#16a34a; }

.tab2-body { display:flex; gap:16px; padding:16px; justify-content:center; flex-wrap:wrap; }
.tab2-left { background:#fff; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,.08); padding:16px; min-width:300px; flex:1; max-width:480px; }
.tab2-right { background:#fff; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,.08); padding:16px; flex:1; min-width:300px; max-width:560px; }

.path-list { max-height:180px; overflow-y:auto; font-family:'Consolas',monospace; font-size:0.72rem; padding:6px;
  background:#f8fafc; border-radius:6px; margin-top:8px; }
.path-list .path-item { padding:3px 6px; border-bottom:1px solid #e2e8f0; }
.path-list .path-item:last-child { border:none; }
.stats-box { display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; margin-top:10px; }
.stat-card { background:#f1f5f9; border-radius:8px; padding:8px; text-align:center; }
.stat-card .stat-val { font-size:1.2rem; font-weight:700; color:#2563eb; transition:color .3s; }
.stat-card .stat-label { font-size:0.65rem; color:#64748b; }
.stat-card .stat-val.warn { color:#f59e0b; }
.stat-card .stat-val.danger { color:#dc2626; }

/* Queue cards */
.queue-cards { display:flex; gap:6px; flex-wrap:wrap; margin-top:8px; max-height:200px; overflow-y:auto; padding:4px; }
.q-card { background:#eff6ff; border:1px solid #bfdbfe; border-radius:8px; padding:6px 8px; font-size:0.65rem;
  min-width:120px; max-width:180px; transition:all .3s; }
.q-card.highlight { border-color:#f59e0b; background:#fffbeb; box-shadow:0 0 8px rgba(245,158,11,.3); }
.q-card .qc-pos { font-weight:700; color:#2563eb; margin-bottom:2px; }
.q-card .qc-path { color:#475569; font-family:'Consolas',monospace; word-break:break-all; margin-bottom:2px; }
.q-card .qc-visited { display:grid; grid-template-columns:repeat(4,12px); gap:1px; }
.q-card .qc-bit { width:12px; height:12px; border-radius:2px; background:#e2e8f0; border:1px solid #cbd5e1; }
.q-card .qc-bit.on { background:#3b82f6; border-color:#2563eb; }

/* Counters bar */
.counters-bar { display:flex; gap:10px; justify-content:center; padding:8px; background:#f8fafc;
  border-radius:8px; margin:8px 0; flex-wrap:wrap; }
.counter-item { display:flex; align-items:center; gap:4px; font-size:0.78rem; font-weight:600; }
.counter-item .ci-icon { font-size:1rem; }
.counter-item .ci-val { font-family:'Consolas',monospace; font-weight:800; transition:color .3s; }

/* â”€â”€ Responsive â”€â”€ */
@media (max-width:768px) {
  .panels, .tab2-body { flex-direction:column; align-items:center; }
  .panel, .tab2-left, .tab2-right { max-width:100%; }
  .grid { grid-template-columns:repeat(4,56px); grid-template-rows:repeat(4,56px); }
  .cell { width:56px; height:56px; }
  .t2-btn-group { flex-direction:column; align-items:center; }
}
</style>
</head>
<body>

<!-- SVG defs for arrow markers -->
<svg style="position:absolute;width:0;height:0;">
  <defs>
    <marker id="arrowHead" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto">
      <path d="M0,0 L8,3 L0,6 Z" fill="#6366f1"/>
    </marker>
    <marker id="arrowHeadBFS" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto">
      <path d="M0,0 L8,3 L0,6 Z" fill="#2563eb"/>
    </marker>
    <marker id="arrowHeadDFS" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto">
      <path d="M0,0 L8,3 L0,6 Z" fill="#dc2626"/>
    </marker>
    <marker id="arrowHeadGreen" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto">
      <path d="M0,0 L8,3 L0,6 Z" fill="#16a34a"/>
    </marker>
    <marker id="arrowHeadYellow" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto">
      <path d="M0,0 L8,3 L0,6 Z" fill="#eab308"/>
    </marker>
  </defs>
</svg>

<div class="header" style="position:relative;">
  <a href="../index.html" class="back-link">&#8592; ë©”ì¸</a>
  <h1>BFS vs DFS ë¹„êµ ì‹œë®¬ë ˆì´ì…˜</h1>
  <p>4x4 ê²©ìì—ì„œ BFSì™€ DFSì˜ íƒìƒ‰ ê³¼ì •ì„ ë¹„êµí•©ë‹ˆë‹¤</p>
</div>

<!-- Tabs -->
<div class="tabs">
  <button class="tab-btn active" onclick="switchTab(0)">íƒ­ 1: ìµœë‹¨ê±°ë¦¬ ë¹„êµ</button>
  <button class="tab-btn" onclick="switchTab(1)">íƒ­ 2: ëª¨ë“  ê²½ë¡œ íƒìƒ‰</button>
</div>

<!-- ===================== TAB 1 ===================== -->
<div id="tab0" class="tab-content active">
  <div class="controls">
    <button class="btn-start" id="t1-start" onclick="tab1Start()">ì‹œì‘</button>
    <button class="btn-reset" onclick="tab1Reset()">ì´ˆê¸°í™”</button>
    <div class="speed-wrap">
      <span>ëŠë¦¬ê²Œ</span>
      <input type="range" id="t1-speed" min="1" max="10" value="5">
      <span>ë¹ ë¥´ê²Œ</span>
    </div>
    <span style="font-size:0.78rem;color:#64748b;">ì…€ í´ë¦­ = ì¥ì• ë¬¼ í† ê¸€</span>
  </div>

  <div class="legend">
    <div class="legend-item"><div class="legend-box" style="background:#dbeafe;border-color:#2563eb;"></div>ì‹œì‘ì </div>
    <div class="legend-item"><div class="legend-box" style="background:#fef3c7;border-color:#f59e0b;"></div>ëì </div>
    <div class="legend-item"><div class="legend-box" style="background:#1e293b;border-color:#0f172a;"></div>ì¥ì• ë¬¼</div>
    <div class="legend-item"><div class="legend-box" style="background:#bfdbfe;border-color:#3b82f6;"></div>íƒìƒ‰ ì¤‘</div>
    <div class="legend-item"><div class="legend-box" style="background:#e0e7ff;border-color:#6366f1;"></div>ë°©ë¬¸ ì™„ë£Œ</div>
    <div class="legend-item"><div class="legend-box" style="background:#bbf7d0;border-color:#16a34a;"></div>ìµœì¢… ê²½ë¡œ</div>
  </div>

  <!-- ë°©ë¬¸ íšŸìˆ˜ ë¹„êµ ë°” -->
  <div class="counters-bar" id="t1-compare" style="display:none; margin:0 16px;">
    <div class="counter-item"><span style="color:#2563eb;font-weight:800;">BFS</span> ë°©ë¬¸: <span class="ci-val" id="t1-bfs-cnt">0</span>ê°œ</div>
    <div class="counter-item"><span style="color:#dc2626;font-weight:800;">DFS</span> ë°©ë¬¸: <span class="ci-val" id="t1-dfs-cnt">0</span>ê°œ</div>
    <div class="counter-item" id="t1-extra-wrap" style="display:none;">DFS ì¶”ê°€ íƒìƒ‰: <span class="ci-val" id="t1-dfs-extra" style="color:#dc2626;">+0</span>ê°œ</div>
  </div>

  <div class="panels">
    <div class="panel">
      <h3 class="bfs-title">BFS (ë„ˆë¹„ ìš°ì„  íƒìƒ‰)</h3>
      <div class="grid-container" id="bfs-grid-container">
        <div class="grid" id="bfs-grid"></div>
      </div>
      <div class="info-area" id="bfs-info">
        <div class="label">í (Queue):</div>
        <div class="queue-state" id="bfs-queue">[ ]</div>
        <div class="depth-info" id="bfs-depth"></div>
        <div id="bfs-msg"></div>
      </div>
    </div>
    <div class="panel">
      <h3 class="dfs-title">DFS (ê¹Šì´ ìš°ì„  íƒìƒ‰)</h3>
      <div class="grid-container" id="dfs-grid-container">
        <div class="grid" id="dfs-grid"></div>
      </div>
      <div class="info-area" id="dfs-info">
        <div class="label">ê²½ë¡œ (í˜„ì¬ ìŠ¤íƒ):</div>
        <div class="stack-state" id="dfs-stack">[ ]</div>
        <div class="depth-info" id="dfs-depth"></div>
        <div id="dfs-msg"></div>
      </div>
    </div>
  </div>
  <!-- ìµœì¢… ë¹„êµ ê²°ê³¼ -->
  <div id="t1-final-compare" style="display:none; margin:0 16px 16px; padding:12px; background:#fff; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,.08); text-align:center; font-size:0.85rem; font-weight:600;"></div>
</div>

<!-- ===================== TAB 2 ===================== -->
<div id="tab1" class="tab-content">
  <!-- 3 Button Cards -->
  <div class="t2-btn-group">
    <div class="t2-btn-card bc-fail" id="t2-card-1" onclick="tab2Run(1)">
      <div class="bc-num">â‘ </div>
      <div class="bc-title">BFS + ì „ì—­ ë°©ë¬¸ ë°°ì—´</div>
      <div class="bc-desc">ì „ì—­ ë°°ì—´ 1ê°œ ì‚¬ìš© â€” ì™œ ì•ˆ ë ê¹Œ?</div>
    </div>
    <div class="t2-btn-card bc-warn" id="t2-card-2" onclick="tab2Run(2)">
      <div class="bc-num">â‘¡</div>
      <div class="bc-title">BFS + ë°°ì—´ ë³µì‚¬</div>
      <div class="bc-desc">ê²½ë¡œë§ˆë‹¤ ë°°ì—´ ë³µì‚¬ â€” ë˜ê¸´ í•˜ëŠ”ë°...?</div>
    </div>
    <div class="t2-btn-card bc-ok" id="t2-card-3" onclick="tab2Run(3)">
      <div class="bc-num">â‘¢</div>
      <div class="bc-title">DFS + ë°±íŠ¸ë˜í‚¹</div>
      <div class="bc-desc">DFS + ë°±íŠ¸ë˜í‚¹ â€” ì´ê²Œ ì •ë‹µ!</div>
    </div>
  </div>

  <!-- Controls -->
  <div class="controls" style="border-top:1px solid #e2e8f0;">
    <button class="btn-reset" onclick="tab2Reset()">ì´ˆê¸°í™”</button>
    <div class="speed-wrap">
      <span>ëŠë¦¬ê²Œ</span>
      <input type="range" id="t2-speed" min="1" max="10" value="5">
      <span>ë¹ ë¥´ê²Œ</span>
    </div>
    <span style="font-size:0.78rem;color:#64748b;">ì…€ í´ë¦­ = ì¥ì• ë¬¼ í† ê¸€</span>
  </div>

  <!-- Counters bar (for mode 2) -->
  <div class="counters-bar" id="t2-counters" style="display:none; margin:0 16px;">
    <div class="counter-item"><span class="ci-icon">ğŸ“‹</span> ë°°ì—´ ë³µì‚¬: <span class="ci-val" id="t2-cnt-copy">0</span>íšŒ</div>
    <div class="counter-item"><span class="ci-icon">ğŸ“¦</span> í ì›ì†Œ: <span class="ci-val" id="t2-cnt-qsize">0</span>ê°œ</div>
    <div class="counter-item"><span class="ci-icon">ğŸ’¾</span> ë©”ëª¨ë¦¬: <span class="ci-val" id="t2-cnt-mem">0</span> x 16ì¹¸</div>
  </div>

  <div class="legend">
    <div class="legend-item"><div class="legend-box" style="background:#dbeafe;border-color:#2563eb;"></div>ì‹œì‘ì </div>
    <div class="legend-item"><div class="legend-box" style="background:#fef3c7;border-color:#f59e0b;"></div>ëì </div>
    <div class="legend-item"><div class="legend-box" style="background:#1e293b;border-color:#0f172a;"></div>ì¥ì• ë¬¼</div>
    <div class="legend-item"><div class="legend-box" style="background:#bfdbfe;border-color:#3b82f6;"></div>íƒìƒ‰ ì¤‘</div>
    <div class="legend-item"><div class="legend-box" style="background:#e0e7ff;border-color:#6366f1;"></div>ë°©ë¬¸ ì™„ë£Œ</div>
    <div class="legend-item"><div class="legend-box" style="background:#fee2e2;border-color:#ef4444;"></div>ì°¨ë‹¨ë¨</div>
    <div class="legend-item"><div class="legend-box" style="background:#bbf7d0;border-color:#16a34a;"></div>ê²½ë¡œ ë°œê²¬</div>
  </div>

  <div class="tab2-body">
    <div class="tab2-left">
      <h3 id="t2-grid-title" style="color:#475569;">ê²©ì & íƒìƒ‰ ì‹œê°í™”</h3>
      <div class="grid-container" id="t2-grid-container">
        <div class="grid" id="t2-grid"></div>
      </div>
      <div class="info-area" id="t2-info">
        <div class="label" id="t2-ds-label">í / ìŠ¤íƒ:</div>
        <div class="queue-state" id="t2-ds-state">[ ]</div>
        <div class="depth-info" id="t2-depth"></div>
        <div id="t2-msg"></div>
      </div>
      <!-- Queue cards area (mode 2) -->
      <div id="t2-qcards-wrap" style="display:none;">
        <div class="label" style="margin-top:10px;font-weight:700;color:#475569;">í ì›ì†Œ ì¹´ë“œ (ê°ì ë°©ë¬¸ ë°°ì—´ ë³µì‚¬ë³¸ ë³´ìœ ):</div>
        <div class="queue-cards" id="t2-qcards"></div>
      </div>
    </div>
    <div class="tab2-right">
      <h3 style="color:#475569;">ë°œê²¬ëœ ê²½ë¡œ ëª©ë¡</h3>
      <div class="path-list" id="t2-path-list"><span style="color:#94a3b8;">ë²„íŠ¼ì„ ì„ íƒí•˜ì—¬ íƒìƒ‰ì„ ì‹œì‘í•˜ì„¸ìš”.</span></div>
      <div class="stats-box">
        <div class="stat-card"><div class="stat-val" id="t2-stat-paths">0</div><div class="stat-label">ë°œê²¬ ê²½ë¡œ ìˆ˜</div></div>
        <div class="stat-card"><div class="stat-val" id="t2-stat-visits">0</div><div class="stat-label">ì´ ë°©ë¬¸ íšŸìˆ˜</div></div>
        <div class="stat-card"><div class="stat-val" id="t2-stat-maxds">0</div><div class="stat-label">ìµœëŒ€ í/ìŠ¤íƒ</div></div>
      </div>
    </div>
  </div>
</div>

<script>
/* ================================================================
   ê³µí†µ ìƒìˆ˜ & ìœ í‹¸
   ================================================================ */
const ROWS=4, COLS=4;
const START=[0,0], END=[3,3];
const DR=[-1,1,0,0], DC=[0,0,-1,1]; // ìƒí•˜ì¢Œìš°
const CELL_SIZE=64, GAP=3;

let walls = Array.from({length:ROWS},()=>Array(COLS).fill(false));
let t1Running=false, t2Running=false;
let t1Timer=null, t2Timer=null;

function inBounds(r,c){return r>=0&&r<ROWS&&c>=0&&c<COLS;}
function isStart(r,c){return r===START[0]&&c===START[1];}
function isEnd(r,c){return r===END[0]&&c===END[1];}
function speedMs(sliderId){
  const v=document.getElementById(sliderId).value;
  return 1100 - v*100;
}
function coordStr(r,c){return `(${r},${c})`;}

/* ================================================================
   íƒ­ ì „í™˜
   ================================================================ */
function switchTab(idx){
  document.querySelectorAll('.tab-btn').forEach((b,i)=>b.classList.toggle('active',i===idx));
  document.querySelectorAll('.tab-content').forEach((d,i)=>d.classList.toggle('active',i===idx));
}

/* ================================================================
   ê²©ì ìƒì„± (ê³µí†µ)
   ================================================================ */
function buildGrid(containerId, gridId, onClick){
  const grid=document.getElementById(gridId);
  grid.innerHTML='';
  for(let r=0;r<ROWS;r++){
    for(let c=0;c<COLS;c++){
      const cell=document.createElement('div');
      cell.className='cell';
      cell.id=gridId+'-'+r+'-'+c;
      cell.innerHTML=`<span class="coord">${r},${c}</span><span class="depth-num" id="${gridId}-d-${r}-${c}"></span><span class="visit-order" id="${gridId}-o-${r}-${c}"></span>`;
      if(isStart(r,c)) cell.classList.add('start');
      if(isEnd(r,c)) cell.classList.add('end');
      if(walls[r][c]) cell.classList.add('wall');
      cell.addEventListener('click',()=>onClick(r,c));
      grid.appendChild(cell);
    }
  }
  const container=document.getElementById(containerId);
  let svg=container.querySelector('.svg-overlay');
  if(svg) svg.remove();
  svg=document.createElementNS('http://www.w3.org/2000/svg','svg');
  svg.setAttribute('class','svg-overlay');
  const w=COLS*CELL_SIZE+(COLS-1)*GAP;
  const h=ROWS*CELL_SIZE+(ROWS-1)*GAP;
  svg.setAttribute('width',w);
  svg.setAttribute('height',h);
  svg.innerHTML='';
  container.style.position='relative';
  container.style.width=w+'px';
  container.style.height=h+'px';
  container.style.margin='0 auto';
  container.appendChild(svg);
}

function cellCenter(r,c){
  const x=c*(CELL_SIZE+GAP)+CELL_SIZE/2;
  const y=r*(CELL_SIZE+GAP)+CELL_SIZE/2;
  return {x,y};
}

function drawArrow(svg, r1,c1, r2,c2, cls){
  const p1=cellCenter(r1,c1), p2=cellCenter(r2,c2);
  const dx=p2.x-p1.x, dy=p2.y-p1.y;
  const len=Math.sqrt(dx*dx+dy*dy);
  const shorten=14;
  const sx=p1.x+dx/len*shorten, sy=p1.y+dy/len*shorten;
  const ex=p2.x-dx/len*shorten, ey=p2.y-dy/len*shorten;
  const line=document.createElementNS('http://www.w3.org/2000/svg','line');
  line.setAttribute('x1',sx); line.setAttribute('y1',sy);
  line.setAttribute('x2',ex); line.setAttribute('y2',ey);
  line.setAttribute('class','arrow-line '+cls);
  if(cls.includes('arrow-final')){
    line.setAttribute('marker-end','url(#arrowHeadGreen)');
  } else if(cls.includes('arrow-bfs')){
    line.setAttribute('marker-end','url(#arrowHeadBFS)');
  } else if(cls.includes('arrow-dfs')){
    line.setAttribute('marker-end','url(#arrowHeadDFS)');
  }
  svg.appendChild(line);
  return line;
}

function clearSVG(containerId){
  const svg=document.getElementById(containerId).querySelector('.svg-overlay');
  if(svg) svg.innerHTML='';
}

function setCellState(gridId, r, c, state, depth, order){
  const cell=document.getElementById(gridId+'-'+r+'-'+c);
  if(!cell) return;
  cell.classList.remove('visiting','visited','path-final','current','blocked','unvisited-bt','path-temp');
  if(state) cell.classList.add(state);
  const dEl=document.getElementById(gridId+'-d-'+r+'-'+c);
  const oEl=document.getElementById(gridId+'-o-'+r+'-'+c);
  if(depth!==undefined&&depth!==null) dEl.textContent=depth;
  if(order!==undefined&&order!==null) oEl.textContent='#'+order;
}

function resetCellStates(gridId){
  for(let r=0;r<ROWS;r++) for(let c=0;c<COLS;c++){
    const cell=document.getElementById(gridId+'-'+r+'-'+c);
    if(!cell) continue;
    cell.classList.remove('visiting','visited','path-final','current','blocked','unvisited-bt','path-temp');
    if(isStart(r,c)) cell.classList.add('start');
    if(isEnd(r,c)) cell.classList.add('end');
    document.getElementById(gridId+'-d-'+r+'-'+c).textContent='';
    document.getElementById(gridId+'-o-'+r+'-'+c).textContent='';
  }
}

/* ================================================================
   ì¥ì• ë¬¼ í† ê¸€
   ================================================================ */
function toggleWall(r,c){
  if(isStart(r,c)||isEnd(r,c)) return;
  if(t1Running||t2Running) return;
  walls[r][c]=!walls[r][c];
  refreshAllGrids();
}

function refreshAllGrids(){
  buildGrid('bfs-grid-container','bfs-grid',toggleWall);
  buildGrid('dfs-grid-container','dfs-grid',toggleWall);
  buildGrid('t2-grid-container','t2-grid',toggleWall);
}

/* ================================================================
   TAB 1: BFS vs DFS ìµœë‹¨ê±°ë¦¬ ë¹„êµ
   ================================================================ */
let t1BfsVisits=0, t1DfsVisits=0, t1BfsDoneAt=0;
let t1BfsDone=false;

function tab1Start(){
  if(t1Running) return;
  t1Running=true;
  t1BfsDone=false;
  t1BfsVisits=0; t1DfsVisits=0; t1BfsDoneAt=0;
  document.getElementById('t1-start').disabled=true;
  document.getElementById('t1-compare').style.display='flex';
  document.getElementById('t1-extra-wrap').style.display='none';
  document.getElementById('t1-final-compare').style.display='none';
  updateT1Counters();

  const bfsSteps=genBFSSteps();
  const dfsSteps=genDFSSteps();
  let bi=0, di=0;

  function tick(){
    if(!t1Running) return;
    const ms=speedMs('t1-speed');
    // BFS 1ìŠ¤í… (ëë‚˜ì§€ ì•Šì•˜ìœ¼ë©´)
    if(bi<bfsSteps.length){
      const bs=bfsSteps[bi++];
      applyBFSStep(bs);
      if(bs.type==='dequeue') t1BfsVisits++;
      if(bs.type==='found'||bs.type==='notfound'){
        if(!t1BfsDone){ t1BfsDone=true; t1BfsDoneAt=t1BfsVisits; }
      }
    }
    // DFS 1ìŠ¤í… (ëë‚˜ì§€ ì•Šì•˜ìœ¼ë©´)
    if(di<dfsSteps.length){
      const ds=dfsSteps[di++];
      applyDFSStep(ds);
      if(ds.type==='visit') t1DfsVisits++;
    }
    updateT1Counters();
    // BFS ì™„ë£Œ í›„ ì¶”ê°€ íƒìƒ‰ ì¹´ìš´í„°
    if(t1BfsDone&&di<dfsSteps.length){
      document.getElementById('t1-extra-wrap').style.display='flex';
      document.getElementById('t1-dfs-extra').textContent='+'+Math.max(0,t1DfsVisits-t1BfsDoneAt);
    }
    // ì–‘ìª½ ë‹¤ ëë‚¨
    if(bi>=bfsSteps.length&&di>=dfsSteps.length){
      t1Running=false;
      document.getElementById('t1-start').disabled=false;
      showT1FinalCompare();
      return;
    }
    t1Timer=setTimeout(tick, ms);
  }
  tick();
}

function tab1Reset(){
  t1Running=false;
  if(t1Timer) clearTimeout(t1Timer);
  resetCellStates('bfs-grid'); resetCellStates('dfs-grid');
  clearSVG('bfs-grid-container'); clearSVG('dfs-grid-container');
  document.getElementById('bfs-queue').textContent='[ ]';
  document.getElementById('dfs-stack').textContent='[ ]';
  document.getElementById('bfs-depth').textContent='';
  document.getElementById('dfs-depth').textContent='';
  document.getElementById('bfs-msg').innerHTML='';
  document.getElementById('dfs-msg').innerHTML='';
  document.getElementById('t1-start').disabled=false;
  document.getElementById('t1-compare').style.display='none';
  document.getElementById('t1-final-compare').style.display='none';
  t1BfsDone=false; t1BfsVisits=0; t1DfsVisits=0; t1BfsDoneAt=0;
}

function updateT1Counters(){
  document.getElementById('t1-bfs-cnt').textContent=t1BfsVisits;
  document.getElementById('t1-dfs-cnt').textContent=t1DfsVisits;
}

function showT1FinalCompare(){
  const el=document.getElementById('t1-final-compare');
  if(t1BfsVisits===0&&t1DfsVisits===0){
    el.style.display='none'; return;
  }
  el.style.display='block';
  if(t1BfsDoneAt===0){
    el.innerHTML='<span style="color:#dc2626;">ê²½ë¡œê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</span>';
    return;
  }
  const ratio=(t1DfsVisits/t1BfsDoneAt).toFixed(1);
  el.innerHTML=`<span style="color:#2563eb;">BFS: ${t1BfsDoneAt}ë²ˆ</span> ë°©ë¬¸ìœ¼ë¡œ ìµœë‹¨ê±°ë¦¬ í™•ì • &nbsp;/&nbsp; `+
    `<span style="color:#dc2626;">DFS: ${t1DfsVisits}ë²ˆ</span> ë°©ë¬¸ í›„ ìµœë‹¨ê±°ë¦¬ í™•ì •<br>`+
    `<span style="margin-top:4px;display:inline-block;">DFSê°€ <strong>${ratio}ë°°</strong> ë” ë§ì´ íƒìƒ‰í–ˆìŠµë‹ˆë‹¤</span>`;
}

/* â”€â”€ BFS step generation (unchanged logic) â”€â”€ */
function genBFSSteps(){
  const steps=[];
  const visited=Array.from({length:ROWS},()=>Array(COLS).fill(false));
  const depth=Array.from({length:ROWS},()=>Array(COLS).fill(-1));
  const parent=Array.from({length:ROWS},()=>Array(COLS).fill(null));
  const queue=[[START[0],START[1]]];
  visited[START[0]][START[1]]=true;
  depth[START[0]][START[1]]=0;
  let order=1, found=false;
  steps.push({type:'init'});
  while(queue.length>0){
    const [r,c]=queue.shift();
    steps.push({type:'dequeue', cur:[r,c], queue:queue.map(q=>[...q]), depth:depth[r][c], order});
    if(isEnd(r,c)){
      found=true;
      const path=[]; let cr=r,cc=c;
      while(parent[cr][cc]!==null){ path.unshift([cr,cc]); const p=parent[cr][cc]; cr=p[0]; cc=p[1]; }
      path.unshift([START[0],START[1]]);
      steps.push({type:'found', path, depth:depth[r][c], visits:order});
      break;
    }
    for(let d=0;d<4;d++){
      const nr=r+DR[d], nc=c+DC[d];
      if(!inBounds(nr,nc)||walls[nr][nc]||visited[nr][nc]) continue;
      visited[nr][nc]=true; depth[nr][nc]=depth[r][c]+1; parent[nr][nc]=[r,c];
      queue.push([nr,nc]); order++;
      steps.push({type:'enqueue', cur:[r,c], next:[nr,nc], queue:queue.map(q=>[...q]), depth:depth[nr][nc], order});
    }
  }
  if(!found) steps.push({type:'notfound'});
  return steps;
}

/* â”€â”€ DFS step generation â€” ë°±íŠ¸ë˜í‚¹ìœ¼ë¡œ ëª¨ë“  ê²½ë¡œ íƒìƒ‰ í›„ ìµœë‹¨ í™•ì • â”€â”€ */
function genDFSSteps(){
  const steps=[];
  const visited=Array.from({length:ROWS},()=>Array(COLS).fill(false));
  let visitCount=0;
  let bestPath=null, bestLen=Infinity;

  steps.push({type:'init'});

  function dfs(r,c,depth,path){
    visited[r][c]=true;
    visitCount++;
    path.push([r,c]);

    steps.push({type:'visit', cur:[r,c], depth, path:path.map(p=>[...p]), visitCount});

    if(isEnd(r,c)){
      const pathLen=path.length-1;
      if(pathLen<bestLen){
        bestLen=pathLen;
        bestPath=path.map(p=>[...p]);
        steps.push({type:'new-best', path:path.map(p=>[...p]), pathLen, visitCount, isFirst:bestPath!==null&&pathLen===bestLen});
      } else {
        steps.push({type:'path-found-worse', path:path.map(p=>[...p]), pathLen, bestLen, visitCount});
      }
    } else {
      for(let d=0;d<4;d++){
        const nr=r+DR[d], nc=c+DC[d];
        if(!inBounds(nr,nc)||walls[nr][nc]||visited[nr][nc]) continue;
        dfs(nr,nc,depth+1,path);
      }
    }
    // backtrack
    visited[r][c]=false;
    path.pop();
    steps.push({type:'backtrack', cur:[r,c], depth, path:path.map(p=>[...p]), visitCount});
  }

  dfs(START[0],START[1],0,[]);

  if(bestPath){
    steps.push({type:'done', path:bestPath, pathLen:bestLen, visitCount});
  } else {
    steps.push({type:'notfound', visitCount});
  }
  return steps;
}

/* â”€â”€ Apply BFS steps â”€â”€ */
let bfsOrder=0;
function applyBFSStep(step){
  const gridId='bfs-grid';
  const svg=document.getElementById('bfs-grid-container').querySelector('.svg-overlay');
  switch(step.type){
    case 'init':
      bfsOrder=1;
      setCellState(gridId,START[0],START[1],'visiting',0,bfsOrder);
      break;
    case 'dequeue':
      setCellState(gridId,step.cur[0],step.cur[1],'current',step.depth,null);
      document.getElementById('bfs-queue').textContent='[ '+step.queue.map(q=>coordStr(q[0],q[1])).join(', ')+' ]';
      document.getElementById('bfs-depth').textContent='í˜„ì¬ depth: '+step.depth;
      break;
    case 'enqueue':
      bfsOrder++;
      setCellState(gridId,step.next[0],step.next[1],'visiting',step.depth,bfsOrder);
      drawArrow(svg,step.cur[0],step.cur[1],step.next[0],step.next[1],'arrow-bfs');
      document.getElementById('bfs-queue').textContent='[ '+step.queue.map(q=>coordStr(q[0],q[1])).join(', ')+' ]';
      break;
    case 'found':
      svg.innerHTML='';
      for(let i=0;i<step.path.length-1;i++)
        drawArrow(svg,step.path[i][0],step.path[i][1],step.path[i+1][0],step.path[i+1][1],'arrow-bfs arrow-final');
      step.path.forEach(([r,c])=>setCellState(gridId,r,c,'path-final',null,null));
      document.getElementById('bfs-msg').innerHTML='<div class="msg msg-success">ìµœë‹¨ ê²½ë¡œ í™•ì •! ê¸¸ì´: '+step.depth+' (ë°©ë¬¸ '+t1BfsVisits+'íšŒ)</div>';
      document.getElementById('bfs-queue').textContent='ì™„ë£Œ';
      break;
    case 'notfound':
      document.getElementById('bfs-msg').innerHTML='<div class="msg msg-fail">ê²½ë¡œ ì—†ìŒ</div>';
      break;
  }
  if(step.type==='dequeue'||step.type==='enqueue'){
    for(let r=0;r<ROWS;r++) for(let c=0;c<COLS;c++){
      const cell=document.getElementById(gridId+'-'+r+'-'+c);
      if(cell&&cell.classList.contains('current')&&!(r===step.cur[0]&&c===step.cur[1])){
        cell.classList.remove('current'); cell.classList.add('visited');
      }
    }
  }
}

/* â”€â”€ Apply DFS steps (backtracking) â”€â”€ */
let dfsOrder=0;
let dfsBestPathCache=null;
function applyDFSStep(step){
  const gridId='dfs-grid';
  const svg=document.getElementById('dfs-grid-container').querySelector('.svg-overlay');
  switch(step.type){
    case 'init':
      dfsOrder=0;
      dfsBestPathCache=null;
      break;
    case 'visit':
      dfsOrder++;
      // clear current markers
      document.querySelectorAll('#dfs-grid .cell.current').forEach(c=>{
        c.classList.remove('current'); c.classList.add('visited');
      });
      setCellState(gridId,step.cur[0],step.cur[1],'current',step.depth,step.visitCount);
      // draw current path
      svg.innerHTML='';
      // draw best path in yellow if exists
      if(dfsBestPathCache){
        for(let i=0;i<dfsBestPathCache.length-1;i++)
          drawArrow(svg,dfsBestPathCache[i][0],dfsBestPathCache[i][1],dfsBestPathCache[i+1][0],dfsBestPathCache[i+1][1],'arrow-temp');
      }
      // draw exploring path in red
      for(let i=0;i<step.path.length-1;i++)
        drawArrow(svg,step.path[i][0],step.path[i][1],step.path[i+1][0],step.path[i+1][1],'arrow-dfs');
      document.getElementById('dfs-stack').textContent='[ '+step.path.map(p=>coordStr(p[0],p[1])).join(' â†’ ')+' ]';
      document.getElementById('dfs-depth').textContent='í˜„ì¬ depth: '+step.depth;
      break;
    case 'new-best':
      dfsBestPathCache=step.path;
      // highlight best path
      step.path.forEach(([r,c])=>setCellState(gridId,r,c,'path-temp',null,null));
      svg.innerHTML='';
      for(let i=0;i<step.path.length-1;i++)
        drawArrow(svg,step.path[i][0],step.path[i][1],step.path[i+1][0],step.path[i+1][1],'arrow-temp');
      document.getElementById('dfs-msg').innerHTML=
        `<div class="msg msg-warn">ì„ì‹œ ìµœë‹¨ê²½ë¡œ ë°œê²¬! ê¸¸ì´: ${step.pathLen} (ê³„ì† íƒìƒ‰ ì¤‘...)</div>`;
      break;
    case 'path-found-worse':
      document.getElementById('dfs-msg').innerHTML=
        `<div class="msg msg-warn">ê²½ë¡œ ë°œê²¬ (ê¸¸ì´: ${step.pathLen}) â€” í˜„ì¬ ìµœë‹¨ ${step.bestLen}ë³´ë‹¤ ê¹€, ë¬´ì‹œ</div>`;
      break;
    case 'backtrack':
      // unmark cell
      const cell=document.getElementById(gridId+'-'+step.cur[0]+'-'+step.cur[1]);
      if(cell){
        cell.classList.remove('current','visited','path-final','path-temp');
        cell.classList.add('unvisited-bt');
        document.getElementById(gridId+'-d-'+step.cur[0]+'-'+step.cur[1]).textContent='';
        document.getElementById(gridId+'-o-'+step.cur[0]+'-'+step.cur[1]).textContent='';
        if(isStart(step.cur[0],step.cur[1])) cell.classList.add('start');
        if(isEnd(step.cur[0],step.cur[1])) cell.classList.add('end');
      }
      // redraw
      svg.innerHTML='';
      if(dfsBestPathCache){
        for(let i=0;i<dfsBestPathCache.length-1;i++)
          drawArrow(svg,dfsBestPathCache[i][0],dfsBestPathCache[i][1],dfsBestPathCache[i+1][0],dfsBestPathCache[i+1][1],'arrow-temp');
      }
      for(let i=0;i<step.path.length-1;i++)
        drawArrow(svg,step.path[i][0],step.path[i][1],step.path[i+1][0],step.path[i+1][1],'arrow-dfs');
      if(step.path.length>0){
        document.getElementById('dfs-stack').textContent='[ '+step.path.map(p=>coordStr(p[0],p[1])).join(' â†’ ')+' ]';
      } else {
        document.getElementById('dfs-stack').textContent='[ ]';
      }
      break;
    case 'done':
      // final: show confirmed shortest path in green
      resetCellStates(gridId);
      svg.innerHTML='';
      step.path.forEach(([r,c])=>setCellState(gridId,r,c,'path-final',null,null));
      for(let i=0;i<step.path.length-1;i++)
        drawArrow(svg,step.path[i][0],step.path[i][1],step.path[i+1][0],step.path[i+1][1],'arrow-dfs arrow-final');
      document.getElementById('dfs-msg').innerHTML=
        `<div class="msg msg-success">ìµœë‹¨ ê²½ë¡œ í™•ì •! ê¸¸ì´: ${step.pathLen} (ë°©ë¬¸ ${step.visitCount}íšŒ)</div>`;
      break;
    case 'notfound':
      document.getElementById('dfs-msg').innerHTML='<div class="msg msg-fail">ê²½ë¡œ ì—†ìŒ</div>';
      break;
  }
}

/* ================================================================
   TAB 2: ëª¨ë“  ê²½ë¡œ íƒìƒ‰ (3ê°€ì§€ ë°©ë²•)
   ================================================================ */
let t2Mode=0; // 1,2,3
let t2Stats={paths:0, visits:0, maxDS:0, copies:0, qSize:0, mem:0};

function tab2SetButtons(disabled){
  ['t2-card-1','t2-card-2','t2-card-3'].forEach(id=>{
    document.getElementById(id).classList.toggle('disabled',disabled);
  });
}

function tab2Run(mode){
  if(t2Running) return;
  t2Running=true;
  t2Mode=mode;
  tab2SetButtons(true);
  resetCellStates('t2-grid');
  clearSVG('t2-grid-container');
  document.getElementById('t2-path-list').innerHTML='';
  document.getElementById('t2-msg').innerHTML='';
  t2Stats={paths:0, visits:0, maxDS:0, copies:0, qSize:0, mem:0};
  updateT2Stats();

  // mode-specific UI
  const counters=document.getElementById('t2-counters');
  const qcardsWrap=document.getElementById('t2-qcards-wrap');
  counters.style.display=(mode===2)?'flex':'none';
  qcardsWrap.style.display=(mode===2)?'block':'none';
  if(mode===2) document.getElementById('t2-qcards').innerHTML='';
  updateT2Counters();

  if(mode===3){
    document.getElementById('t2-ds-label').textContent='ìŠ¤íƒ (Stack):';
    document.getElementById('t2-ds-state').className='stack-state';
    document.getElementById('t2-grid-title').textContent='â‘¢ DFS + ë°±íŠ¸ë˜í‚¹';
    document.getElementById('t2-grid-title').style.color='#16a34a';
  } else {
    document.getElementById('t2-ds-label').textContent='í (Queue):';
    document.getElementById('t2-ds-state').className='queue-state';
    document.getElementById('t2-grid-title').textContent = mode===1 ? 'â‘  BFS + ì „ì—­ ë°©ë¬¸ ë°°ì—´' : 'â‘¡ BFS + ê²½ë¡œë³„ ë°°ì—´ ë³µì‚¬';
    document.getElementById('t2-grid-title').style.color = mode===1 ? '#dc2626' : '#f59e0b';
  }
  document.getElementById('t2-ds-state').textContent='[ ]';
  document.getElementById('t2-depth').textContent='';

  let steps;
  if(mode===1) steps=genMode1Steps();
  else if(mode===2) steps=genMode2Steps();
  else steps=genMode3Steps();

  let si=0;
  function tick(){
    if(!t2Running||si>=steps.length){
      t2Running=false;
      tab2SetButtons(false);
      return;
    }
    const step=steps[si++];
    if(mode===1) applyMode1Step(step);
    else if(mode===2) applyMode2Step(step);
    else applyMode3Step(step);
    t2Timer=setTimeout(tick, speedMs('t2-speed'));
  }
  tick();
}

function tab2Reset(){
  t2Running=false;
  prevQCards=null;
  if(t2Timer) clearTimeout(t2Timer);
  resetCellStates('t2-grid');
  clearSVG('t2-grid-container');
  document.getElementById('t2-ds-state').textContent='[ ]';
  document.getElementById('t2-depth').textContent='';
  document.getElementById('t2-msg').innerHTML='';
  document.getElementById('t2-path-list').innerHTML='<span style="color:#94a3b8;">ë²„íŠ¼ì„ ì„ íƒí•˜ì—¬ íƒìƒ‰ì„ ì‹œì‘í•˜ì„¸ìš”.</span>';
  document.getElementById('t2-counters').style.display='none';
  document.getElementById('t2-qcards-wrap').style.display='none';
  document.getElementById('t2-grid-title').textContent='ê²©ì & íƒìƒ‰ ì‹œê°í™”';
  document.getElementById('t2-grid-title').style.color='#475569';
  t2Stats={paths:0, visits:0, maxDS:0, copies:0, qSize:0, mem:0};
  updateT2Stats();
  tab2SetButtons(false);
}

function updateT2Stats(){
  document.getElementById('t2-stat-paths').textContent=t2Stats.paths;
  document.getElementById('t2-stat-visits').textContent=t2Stats.visits;
  document.getElementById('t2-stat-maxds').textContent=t2Stats.maxDS;
}

function updateT2Counters(){
  const copyEl=document.getElementById('t2-cnt-copy');
  const qsEl=document.getElementById('t2-cnt-qsize');
  const memEl=document.getElementById('t2-cnt-mem');
  copyEl.textContent=t2Stats.copies;
  qsEl.textContent=t2Stats.qSize;
  memEl.textContent=t2Stats.mem;
  // color escalation
  [copyEl,qsEl,memEl].forEach(el=>{
    const v=parseInt(el.textContent);
    if(v>50) el.style.color='#dc2626';
    else if(v>20) el.style.color='#f59e0b';
    else el.style.color='#333';
  });
}

function addPathToList(pathArr, num){
  const str=pathArr.map(p=>coordStr(p[0],p[1])).join(' â†’ ');
  const el=document.getElementById('t2-path-list');
  const item=document.createElement('div');
  item.className='path-item';
  item.textContent=`ê²½ë¡œ ${num}: ${str} (ê¸¸ì´: ${pathArr.length-1})`;
  el.appendChild(item);
  el.scrollTop=el.scrollHeight;
}

/* â”€â”€ ì‹¤ì œ ëª¨ë“  ê²½ë¡œ ìˆ˜ ê³„ì‚° (ë¹„êµìš©) â”€â”€ */
function countAllPaths(){
  const visited=Array.from({length:ROWS},()=>Array(COLS).fill(false));
  let count=0;
  function dfs(r,c){
    if(isEnd(r,c)){ count++; return; }
    visited[r][c]=true;
    for(let d=0;d<4;d++){
      const nr=r+DR[d], nc=c+DC[d];
      if(!inBounds(nr,nc)||walls[nr][nc]||visited[nr][nc]) continue;
      dfs(nr,nc);
    }
    visited[r][c]=false;
  }
  dfs(START[0],START[1]);
  return count;
}

/* ================================================================
   MODE 1: BFS + ì „ì—­ ë°©ë¬¸ ë°°ì—´ 1ê°œ (ì˜¤ì‘ë™)
   ================================================================ */
function genMode1Steps(){
  const steps=[];
  const visited=Array.from({length:ROWS},()=>Array(COLS).fill(false));
  const queue=[ {pos:[START[0],START[1]], path:[[START[0],START[1]]], depth:0} ];
  visited[START[0]][START[1]]=true;
  let visitCount=0, maxQ=1, pathCount=0;
  let blockedCount=0;
  const totalPaths=countAllPaths();

  steps.push({type:'init', visited:visited.map(r=>[...r])});

  while(queue.length>0){
    const item=queue.shift();
    const [r,c]=item.pos;
    visitCount++;

    steps.push({type:'dequeue', cur:[r,c], path:item.path.map(p=>[...p]), depth:item.depth,
      queueSize:queue.length, visitCount, maxQ, visited:visited.map(r=>[...r])});

    if(isEnd(r,c)){
      pathCount++;
      steps.push({type:'path-found', path:item.path.map(p=>[...p]), pathCount, visitCount, maxQ,
        visited:visited.map(r=>[...r])});
      continue;
    }

    for(let d=0;d<4;d++){
      const nr=r+DR[d], nc=c+DC[d];
      if(!inBounds(nr,nc)||walls[nr][nc]) continue;
      if(visited[nr][nc]){
        // ìê¸° ê²½ë¡œì— ì˜í•œ ì°¨ë‹¨ì€ ë¬´ì‹œ, ë‹¤ë¥¸ ê²½ë¡œì— ì˜í•œ ì°¨ë‹¨ë§Œ í‘œì‹œ
        const inOwnPath=item.path.some(p=>p[0]===nr&&p[1]===nc);
        if(!inOwnPath){
          blockedCount++;
          steps.push({type:'blocked', cur:[r,c], target:[nr,nc], blockedCount, visitCount,
            visited:visited.map(r=>[...r]), path:item.path.map(p=>[...p])});
        }
        continue;
      }
      visited[nr][nc]=true;
      const newPath=[...item.path,[nr,nc]];
      queue.push({pos:[nr,nc], path:newPath, depth:item.depth+1});
    }
    if(queue.length>maxQ) maxQ=queue.length;
    steps.push({type:'expand', queueSize:queue.length, maxQ, visitCount});
  }

  steps.push({type:'done', pathCount, visitCount, maxQ, totalPaths, blockedCount,
    visited:visited.map(r=>[...r])});
  return steps;
}

/* ì „ì—­ visited ìƒíƒœë¥¼ ê²©ìì— ë°˜ì˜í•˜ëŠ” í—¬í¼ */
function renderGlobalVisited(gridId, visited, curPath){
  resetCellStates(gridId);
  // 1) ì „ì—­ visited ë°°ì—´ì—ì„œ ë°©ë¬¸ëœ ì…€ì„ ëª¨ë‘ 'visited'ë¡œ í‘œì‹œ
  const pathSet=new Set(curPath?curPath.map(p=>p[0]*COLS+p[1]):[]);
  for(let r=0;r<ROWS;r++) for(let c=0;c<COLS;c++){
    if(!visited[r][c]||walls[r][c]) continue;
    if(isStart(r,c)||isEnd(r,c)) continue;
    if(pathSet.has(r*COLS+c)) continue; // í˜„ì¬ ê²½ë¡œëŠ” ë³„ë„ ì²˜ë¦¬
    setCellState(gridId,r,c,'visited',null,null);
  }
  // 2) í˜„ì¬ ê²½ë¡œë¥¼ ìœ„ì— ë®ì–´ì“°ê¸°
  if(curPath){
    curPath.forEach(([r,c],i)=>{
      if(i===curPath.length-1) setCellState(gridId,r,c,'current',i,null);
      else setCellState(gridId,r,c,'visiting',i,null);
    });
  }
}

function applyMode1Step(step){
  const gridId='t2-grid';
  const svg=document.getElementById('t2-grid-container').querySelector('.svg-overlay');
  switch(step.type){
    case 'init':
      setCellState(gridId,START[0],START[1],'visiting',0,1);
      break;
    case 'dequeue':
      t2Stats.visits=step.visitCount;
      if(step.queueSize+1>t2Stats.maxDS) t2Stats.maxDS=step.queueSize+1;
      // ì „ì—­ visited ì „ì²´ë¥¼ ê²©ìì— í‘œì‹œ + í˜„ì¬ ê²½ë¡œ ì˜¤ë²„ë ˆì´
      renderGlobalVisited(gridId, step.visited, step.path);
      svg.innerHTML='';
      for(let i=0;i<step.path.length-1;i++)
        drawArrow(svg,step.path[i][0],step.path[i][1],step.path[i+1][0],step.path[i+1][1],'arrow-bfs');
      document.getElementById('t2-ds-state').textContent=`í í¬ê¸°: ${step.queueSize}`;
      document.getElementById('t2-depth').textContent='í˜„ì¬ depth: '+step.depth;
      updateT2Stats();
      break;
    case 'blocked':
      t2Stats.visits=step.visitCount;
      // ì „ì—­ visited í‘œì‹œ + í˜„ì¬ ê²½ë¡œ
      renderGlobalVisited(gridId, step.visited, step.path);
      // ì°¨ë‹¨ëœ ì…€ì„ ë¹¨ê°„ìƒ‰ìœ¼ë¡œ ê°•ì¡°
      setCellState(gridId,step.target[0],step.target[1],'blocked',null,null);
      const bCell=document.getElementById(gridId+'-d-'+step.target[0]+'-'+step.target[1]);
      bCell.textContent='X';
      bCell.style.color='#dc2626';
      updateT2Stats();
      break;
    case 'path-found':
      t2Stats.paths=step.pathCount;
      renderGlobalVisited(gridId, step.visited, null);
      step.path.forEach(([r,c])=>setCellState(gridId,r,c,'path-final',null,null));
      svg.innerHTML='';
      for(let i=0;i<step.path.length-1;i++)
        drawArrow(svg,step.path[i][0],step.path[i][1],step.path[i+1][0],step.path[i+1][1],'arrow-bfs arrow-final');
      addPathToList(step.path, step.pathCount);
      updateT2Stats();
      break;
    case 'expand':
      t2Stats.maxDS=step.maxQ;
      updateT2Stats();
      break;
    case 'done':
      t2Stats.paths=step.pathCount;
      t2Stats.visits=step.visitCount;
      t2Stats.maxDS=step.maxQ;
      updateT2Stats();
      // ìµœì¢…: ì „ì—­ visited ì „ì²´ë¥¼ ë³´ì—¬ì¤Œ
      renderGlobalVisited(gridId, step.visited, null);
      const missing=step.totalPaths - step.pathCount;
      let msg;
      if(step.pathCount===0){
        msg='<div class="msg msg-fail">ê²½ë¡œë¥¼ í•˜ë‚˜ë„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</div>';
      } else {
        msg=`<div class="msg msg-fail">ì „ì—­ ë°©ë¬¸ ë°°ì—´ 1ê°œë¡œëŠ” ëª¨ë“  ê²½ë¡œë¥¼ íƒìƒ‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤!<br>`+
          `ë°œê²¬: ${step.pathCount}ê°œ / ì‹¤ì œ: ${step.totalPaths}ê°œ (${missing}ê°œ ëˆ„ë½)<br>`+
          `ì°¨ë‹¨ íšŸìˆ˜: ${step.blockedCount}íšŒ â€” ë¨¼ì € ë°©ë¬¸ëœ ë…¸ë“œê°€ ë‹¤ë¥¸ ê²½ë¡œë¥¼ ì°¨ë‹¨í–ˆìŠµë‹ˆë‹¤.</div>`;
      }
      document.getElementById('t2-msg').innerHTML=msg;
      break;
  }
}

/* ================================================================
   MODE 2: BFS + ê²½ë¡œë³„ ë°©ë¬¸ ë°°ì—´ ë³µì‚¬ (ë©”ëª¨ë¦¬ í­ë°œ)
   ================================================================ */
function genMode2Steps(){
  const steps=[];
  const initVisited=Array.from({length:ROWS},()=>Array(COLS).fill(false));
  initVisited[START[0]][START[1]]=true;
  // each queue entry: {pos, path, visited (2d copy)}
  const queue=[ {pos:[START[0],START[1]], path:[[START[0],START[1]]], visited:initVisited} ];
  let visitCount=0, maxQ=1, pathCount=0, copyCount=0;

  steps.push({type:'init'});

  while(queue.length>0){
    const item=queue.shift();
    const [r,c]=item.pos;
    visitCount++;

    // snapshot queue for card display (limit to 12 cards for perf)
    const qSnap=queue.slice(0,12).map(q=>({
      pos:[...q.pos],
      path:q.path.map(p=>[...p]),
      visited:q.visited.map(row=>[...row])
    }));

    steps.push({type:'dequeue', cur:[r,c], path:item.path.map(p=>[...p]), depth:item.path.length-1,
      queueSize:queue.length, visitCount, maxQ, copyCount, qSnap, totalInQ:queue.length});

    if(isEnd(r,c)){
      pathCount++;
      steps.push({type:'path-found', path:item.path.map(p=>[...p]), pathCount, visitCount, maxQ, copyCount,
        queueSize:queue.length});
      continue;
    }

    for(let d=0;d<4;d++){
      const nr=r+DR[d], nc=c+DC[d];
      if(!inBounds(nr,nc)||walls[nr][nc]||item.visited[nr][nc]) continue;
      // COPY the visited array
      const newVisited=item.visited.map(row=>[...row]);
      newVisited[nr][nc]=true;
      copyCount++;
      const newPath=[...item.path,[nr,nc]];
      queue.push({pos:[nr,nc], path:newPath, visited:newVisited});
    }
    if(queue.length>maxQ) maxQ=queue.length;

    steps.push({type:'expand', queueSize:queue.length, maxQ, visitCount, copyCount});

    if(queue.length>300){
      steps.push({type:'abort', queueSize:queue.length, maxQ, visitCount, pathCount, copyCount,
        msg:`í í¬ê¸° ${queue.length}ê°œ, ë°°ì—´ ë³µì‚¬ ${copyCount}íšŒ â€” ë©”ëª¨ë¦¬ í­ë°œë¡œ íƒìƒ‰ì„ ì¤‘ë‹¨í•©ë‹ˆë‹¤!`});
      break;
    }
  }

  steps.push({type:'done', pathCount, visitCount, maxQ, copyCount});
  return steps;
}

function renderQueueCards(qSnap, totalInQ){
  const container=document.getElementById('t2-qcards');
  container.innerHTML='';
  qSnap.forEach((q,idx)=>{
    const card=document.createElement('div');
    card.className='q-card'+(idx===0?' highlight':'');
    // position
    let html=`<div class="qc-pos">ìœ„ì¹˜: ${coordStr(q.pos[0],q.pos[1])}</div>`;
    // path
    html+=`<div class="qc-path">${q.path.map(p=>coordStr(p[0],p[1])).join('â†’')}</div>`;
    // visited bitmap
    html+='<div class="qc-visited">';
    for(let r=0;r<ROWS;r++) for(let c=0;c<COLS;c++){
      html+=`<div class="qc-bit${q.visited[r][c]?' on':''}"></div>`;
    }
    html+='</div>';
    card.innerHTML=html;
    container.appendChild(card);
  });
  if(totalInQ>qSnap.length){
    const more=document.createElement('div');
    more.className='q-card';
    more.style.display='flex'; more.style.alignItems='center'; more.style.justifyContent='center';
    more.style.color='#64748b'; more.style.fontWeight='700';
    more.textContent=`... +${totalInQ-qSnap.length}ê°œ ë”`;
    container.appendChild(more);
  }
}

let prevQCards=null;
function applyMode2Step(step){
  const gridId='t2-grid';
  const svg=document.getElementById('t2-grid-container').querySelector('.svg-overlay');
  switch(step.type){
    case 'init':
      setCellState(gridId,START[0],START[1],'visiting',0,1);
      break;
    case 'dequeue':
      t2Stats.visits=step.visitCount;
      t2Stats.copies=step.copyCount;
      t2Stats.qSize=step.totalInQ;
      t2Stats.mem=step.copyCount;
      if(step.queueSize+1>t2Stats.maxDS) t2Stats.maxDS=step.queueSize+1;
      resetCellStates(gridId);
      step.path.forEach(([r,c],i)=>{
        if(i===step.path.length-1) setCellState(gridId,r,c,'current',i,null);
        else setCellState(gridId,r,c,'visiting',i,null);
      });
      svg.innerHTML='';
      for(let i=0;i<step.path.length-1;i++)
        drawArrow(svg,step.path[i][0],step.path[i][1],step.path[i+1][0],step.path[i+1][1],'arrow-bfs');
      document.getElementById('t2-ds-state').textContent=`í í¬ê¸°: ${step.totalInQ} | í˜„ì¬: ${step.path.map(p=>coordStr(p[0],p[1])).join('â†’')}`;
      document.getElementById('t2-depth').textContent='í˜„ì¬ depth: '+step.depth;
      if(prevQCards) renderQueueCards(prevQCards.qSnap, prevQCards.totalInQ);
      else document.getElementById('t2-qcards').innerHTML='';
      prevQCards={qSnap:step.qSnap, totalInQ:step.totalInQ};
      updateT2Stats();
      updateT2Counters();
      break;
    case 'path-found':
      t2Stats.paths=step.pathCount;
      t2Stats.copies=step.copyCount;
      t2Stats.qSize=step.queueSize;
      t2Stats.mem=step.copyCount;
      resetCellStates(gridId);
      step.path.forEach(([r,c])=>setCellState(gridId,r,c,'path-final',null,null));
      svg.innerHTML='';
      for(let i=0;i<step.path.length-1;i++)
        drawArrow(svg,step.path[i][0],step.path[i][1],step.path[i+1][0],step.path[i+1][1],'arrow-bfs arrow-final');
      addPathToList(step.path, step.pathCount);
      updateT2Stats();
      updateT2Counters();
      break;
    case 'expand':
      t2Stats.maxDS=step.maxQ;
      t2Stats.copies=step.copyCount;
      t2Stats.qSize=step.queueSize;
      t2Stats.mem=step.copyCount;
      updateT2Stats();
      updateT2Counters();
      break;
    case 'abort':
      t2Stats.paths=step.pathCount;
      t2Stats.visits=step.visitCount;
      t2Stats.maxDS=step.maxQ;
      t2Stats.copies=step.copyCount;
      t2Stats.qSize=step.queueSize;
      t2Stats.mem=step.copyCount;
      updateT2Stats();
      updateT2Counters();
      document.getElementById('t2-msg').innerHTML=
        `<div class="msg msg-warn">ëª¨ë“  ê²½ë¡œëŠ” ì°¾ì„ ìˆ˜ ìˆì§€ë§Œ, ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ì´ í­ë°œì ìœ¼ë¡œ ì¦ê°€í•©ë‹ˆë‹¤!<br>`+
        `ë°°ì—´ ë³µì‚¬ ${step.copyCount}íšŒ, ìµœëŒ€ í ${step.maxQ}ê°œ<br>${step.msg}</div>`;
      t2Running=false;
      tab2SetButtons(false);
      break;
    case 'done':
      t2Stats.paths=step.pathCount;
      t2Stats.visits=step.visitCount;
      t2Stats.maxDS=step.maxQ;
      t2Stats.copies=step.copyCount;
      t2Stats.mem=step.copyCount;
      updateT2Stats();
      updateT2Counters();
      document.getElementById('t2-msg').innerHTML=
        `<div class="msg msg-warn">ëª¨ë“  ê²½ë¡œëŠ” ì°¾ì„ ìˆ˜ ìˆì§€ë§Œ, ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ì´ í­ë°œì ìœ¼ë¡œ ì¦ê°€í•©ë‹ˆë‹¤!<br>`+
        `ë°œê²¬: ${step.pathCount}ê°œ | ë°°ì—´ ë³µì‚¬: ${step.copyCount}íšŒ | ìµœëŒ€ í: ${step.maxQ}ê°œ</div>`;
      break;
  }
}

/* ================================================================
   MODE 3: DFS + ë°±íŠ¸ë˜í‚¹ (ì˜¬ë°”ë¥¸ í•´ë²•)
   ================================================================ */
function genMode3Steps(){
  const steps=[];
  const visited=Array.from({length:ROWS},()=>Array(COLS).fill(false));
  let visitCount=0, maxStack=0, pathCount=0;

  function dfs(r,c,depth,path){
    visited[r][c]=true;
    visitCount++;
    path.push([r,c]);
    if(path.length>maxStack) maxStack=path.length;

    steps.push({type:'visit', cur:[r,c], depth, path:path.map(p=>[...p]),
      stackSize:path.length, visitCount, maxStack,
      visited:visited.map(row=>[...row])});

    if(isEnd(r,c)){
      pathCount++;
      steps.push({type:'path-found', path:path.map(p=>[...p]), pathCount, visitCount, maxStack});
    } else {
      for(let d=0;d<4;d++){
        const nr=r+DR[d], nc=c+DC[d];
        if(!inBounds(nr,nc)||walls[nr][nc]||visited[nr][nc]) continue;
        dfs(nr,nc,depth+1,path);
      }
    }
    // backtrack
    visited[r][c]=false;
    path.pop();
    steps.push({type:'backtrack', cur:[r,c], depth, path:path.map(p=>[...p]),
      visitCount, maxStack, visited:visited.map(row=>[...row])});
  }

  dfs(START[0],START[1],0,[]);
  steps.push({type:'done', pathCount, visitCount, maxStack});
  return steps;
}

function applyMode3Step(step){
  const gridId='t2-grid';
  const svg=document.getElementById('t2-grid-container').querySelector('.svg-overlay');
  switch(step.type){
    case 'visit':
      t2Stats.visits=step.visitCount;
      if(step.stackSize>t2Stats.maxDS) t2Stats.maxDS=step.stackSize;
      // clear previous current
      document.querySelectorAll('#t2-grid .cell.current').forEach(c=>{
        c.classList.remove('current'); c.classList.add('visited');
      });
      setCellState(gridId,step.cur[0],step.cur[1],'current',step.depth,step.visitCount);
      // draw path arrows
      svg.innerHTML='';
      for(let i=0;i<step.path.length-1;i++)
        drawArrow(svg,step.path[i][0],step.path[i][1],step.path[i+1][0],step.path[i+1][1],'arrow-dfs');
      document.getElementById('t2-ds-state').textContent='[ '+step.path.map(p=>coordStr(p[0],p[1])).join(' â†’ ')+' ]';
      document.getElementById('t2-depth').textContent='í˜„ì¬ depth: '+step.depth;
      updateT2Stats();
      break;
    case 'path-found':
      t2Stats.paths=step.pathCount;
      step.path.forEach(([r,c])=>setCellState(gridId,r,c,'path-final',null,null));
      svg.innerHTML='';
      for(let i=0;i<step.path.length-1;i++)
        drawArrow(svg,step.path[i][0],step.path[i][1],step.path[i+1][0],step.path[i+1][1],'arrow-dfs arrow-final');
      addPathToList(step.path, step.pathCount);
      updateT2Stats();
      break;
    case 'backtrack':
      // unmark cell visually â€” show it returning to unvisited
      const cell=document.getElementById(gridId+'-'+step.cur[0]+'-'+step.cur[1]);
      if(cell){
        cell.classList.remove('current','visited','path-final');
        cell.classList.add('unvisited-bt');
        // clear depth display to show unmark
        document.getElementById(gridId+'-d-'+step.cur[0]+'-'+step.cur[1]).textContent='';
        document.getElementById(gridId+'-o-'+step.cur[0]+'-'+step.cur[1]).textContent='';
        // restore start/end styling
        if(isStart(step.cur[0],step.cur[1])) cell.classList.add('start');
        if(isEnd(step.cur[0],step.cur[1])) cell.classList.add('end');
      }
      // redraw path
      svg.innerHTML='';
      for(let i=0;i<step.path.length-1;i++)
        drawArrow(svg,step.path[i][0],step.path[i][1],step.path[i+1][0],step.path[i+1][1],'arrow-dfs');
      if(step.path.length>0){
        document.getElementById('t2-ds-state').textContent='[ '+step.path.map(p=>coordStr(p[0],p[1])).join(' â†’ ')+' ]';
      } else {
        document.getElementById('t2-ds-state').textContent='[ ]';
      }
      break;
    case 'done':
      t2Stats.paths=step.pathCount;
      t2Stats.visits=step.visitCount;
      t2Stats.maxDS=step.maxStack;
      updateT2Stats();
      if(step.pathCount===0){
        document.getElementById('t2-msg').innerHTML='<div class="msg msg-fail">ê²½ë¡œ ì—†ìŒ</div>';
      } else {
        document.getElementById('t2-msg').innerHTML=
          `<div class="msg msg-success">ì „ì—­ ë°©ë¬¸ ë°°ì—´ 1ê°œë¡œ ëª¨ë“  ê²½ë¡œë¥¼ ì •í™•í•˜ê²Œ íƒìƒ‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!<br>`+
          `ë°œê²¬: ${step.pathCount}ê°œ | ë°©ë¬¸: ${step.visitCount}íšŒ | ìµœëŒ€ ìŠ¤íƒ: ${step.maxStack}</div>`;
      }
      break;
  }
}

/* ================================================================
   ì´ˆê¸°í™”
   ================================================================ */
refreshAllGrids();
</script>
</body>
</html>